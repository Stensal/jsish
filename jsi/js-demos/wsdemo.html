<html>
<body onload='DoInit()' >
Minimal Jsi websocket application.
<!-- RUN WITH: "jsish /zvfs/lib/websrv.jsi -debug 1 wsdemo.html" -->
<p />

<script>
function puts(str) { console.log(str); }
console.log.bind(puts);

var cnt = 0;
function WebMsg(msg) {
  puts("MMM: "+msg.data);
  var resp, s = JSON.parse(msg.data);
  if (s.label == "exit")
     return;
  if (cnt++ >= 10)
     resp = '{"label":"exit"}';
  else
     resp = '{"label":"process"}';
  setTimeout(function() { ws.send(resp); }, 1000);
}

function DoInit() {
    var pcol, url, u = document.URL;
    if (u.substring(0, 5) == "https") {
        pcol = "wss://";
        u = u.substr(8);
    } else {
        pcol = "ws://";
        if (u.substring(0, 4) == "http")
            u = u.substr(7);
    }
    u = u.split('/');
    url = pcol + u[0];
    ws = new WebSocket(url, "jsi-protocol");
    ws.onmessage = WebMsg;
    ws.onopen = function() {
      ws.send('{"label":"init"}');
    };
}

</script>
</body>
</html>
